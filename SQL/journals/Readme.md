## Памятка о типичных ошибках и способах их исправления
collapsed:: true
	- Эта памятка написана, чтобы помочь Вам **самостоятельно находить ошибки в своих запросах**. Если ваш запрос не принимается системой, то возвращайтесь на эту страничку и пройдитесь по всем пунктам:
	  
	  1. Приведите синтаксис запроса к общепринятому:
		- если у вас есть время, стоит изучить руководство по стилю SQL [https://www.sqlstyle.guide/ru/](https://www.sqlstyle.guide/ru/)
		- можете отформатировать ваш запрос с помощью, например, [https://codebeautify.org/sqlformatter](https://codebeautify.org/sqlformatter)
		- в любом случае, информации и примеров в курсе достаточно для того, чтобы писать запросы корректно.
		  
		  2. Проверьте, что ключевые слова, названия столбцов и значения в 
		  ячейках, которые необходимо найти, написаны правильно. Особенно обратите
		  внимание, чтобы в русских названиях столбцов не было английских букв.
		  
		  3. Проверьте, что:
		- количество открывающихся скобок равно количеству закрывающихся;
		- запятые разделяют перечисление столбцов, но не ключевые слова;
		- запросы разделяются точкой с запятой.
		  
		  4. Проверьте, что последовательность команд указана верно (она отличается от последовательности выполнения команд в запросе):
		  
		  ```
		  SELECT 'столбцы или * для выбора всех столбцов; обязательно'
		  
		  FROM 'таблица; обязательно'
		  
		  WHERE 'условие/фильтрация, например, city = 'Moscow'; необязательно'
		  
		  GROUP BY 'столбец, по которому хотим сгруппировать данные; необязательно'
		  
		  HAVING 'условие/фильтрация на уровне сгруппированных данных; необязательно'
		  
		  ORDER BY 'столбец, по которому хотим отсортировать вывод; необязательно'
		  ```
		  
		  5.  Если запрос включает подзапросы, выполните сначала подзапросы и удостоверьтесь, что получаете ожидаемый результат.
		  
		  6. **Прочитайте комментарии под заданием**: большинство трудностей уже обсуждалось не один раз.
-
- Intro to SQL.
  collapsed:: true
	- Основные команды перечислены в 
	  [[SQL_commands_1]] [[SQL_commands_2]]
-
- ## Вложенный запрос
  collapsed:: true
	- Вложенный запрос, возвращающий одно значение
		- вложенный запрос в [[WHERE]] описан  [[SQL_sub_query]] и пример использования в [[SQL_subset_examples]]
		- вложенный запрос после [[SELECT]] описан в [[SQL_Select]]
	- вложенный запрос, возвращающий несколько значений
		- [[SQL_ANY_ALL]]
	- Использование вложенных запросов в [[SQL_INSERT_INTO]]
- ### Оператор WITH
  collapsed:: true
	- оператор [[WITH]]
- ### Оконные функции. Оператор OVER, ORDER BY
  collapsed:: true
	- [[SQL_ORDER_BY]]
	- Оконные функции позволяют получить некоторую дополнительную 
	  информацию о выборке данных .  С помощью оконных функций можно 
	  реализовать вычисления для набора строк, некоторым образом связанных с 
	  текущей строкой. При этом использование оконной функции не группирует 
	  несколько строк в одну, а сохраняет все строки запроса. Синтаксис 
	  оконных функций:
	  ```
	  название_функции(выражение) 
	  OVER (
	        PARTITION BY столбец_1, столбец_2, ... - это окно
	        ORDER BY ... - сортировка 
	        ROWS BETWEEN - границы окна
	          ...
	  )
	  ```
	- Причем все разделы **OVER **являются не 
	  обязательными, но обязательно нужно указать либо окно, либо сортировку. 
	  На данном шаге рассмотрим самый простой синтаксис оконного выражения:
	- ```
	  название_функции(выражение) 
	  OVER (
	        ORDER BY ...
	  )
	  ```
	  Такое оконное выражение позволяет выполнять одинаковые действия над 
	  всеми записями таблицы (здесь окно - вся таблица). В качестве функций 
	  можно использовать:
	  **ROW_NUMBER() **- просто нумерация строк;
	  **RANK() **- ранжирование строк - при одинаковом значении строкам присваивается один номер, с пропуском номеров;
	  **DENSE_RANK()** - ранжирование строк без пропуска номеров;
	  **LAG()** - выбирает строку, предшествующую текущей, если таковой нет - выдается **NULL**;
	  **LEAD() **- выбирает строку, следующую за текущей, если таковой нет - выдается **NULL**.
	- ### Пример 1
	  collapsed:: true
		- Вычислить, сколько шагов прошел пользователь. Ранжировать пользователей по убыванию результатов.
		- Запрос
			- ```SQL
			  SELECT student_name, count(DISTINCT step_id) AS Kоличество,
			  - ROW_NUMBER() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Номер
			  - FROM student INNER JOIN step_student USING (student_id)
			  WHERE result = "correct"
			  GROUP BY student_name
			  ```
		- *Результат:*
			- ```SQL
			  Query result:
			  +--------------+------------+-------+
			  | student_name | Kоличество | Номер |
			  +--------------+------------+-------+
			  | student_60   | 32         | 1     |
			  | student_15   | 30         | 2     |
			  | student_18   | 30         | 3     |
			  | student_27   | 30         | 4     |
			  | student_30   | 30         | 5     |
			  | student_31   | 30         | 6     |
			  | student_36   | 30         | 7     |
			                ...
			  | student_5    | 9          | 61    |
			  | student_63   | 9          | 62    |
			  | student_29   | 8          | 63    |
			  | student_47   | 8          | 64    |
			  +--------------+------------+-------+
			  Affected rows: 64
			  ```
		- В этом запросе после того, как были выбраны все студенты, 
		  посчитаны их шаги с правильными ответами, с помощью оконной функции была
		  выполнена сортировка по количеству верных шагов (**count(DISTINCT step_id)**)  и пронумерованы строки (функция **ROW_NUMBER()**).
		- Дополнительно ранжируем студентов.
		- *Запрос:*
			- ```SQL
			  SELECT student_name, count(DISTINCT step_id) AS Kоличество,
			  
			      ROW_NUMBER() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Номер,
			  
			      RANK() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Ранг,
			      DENSE_RANK() OVER (ORDER BY  count(DISTINCT step_id) DESC) AS Рейтинг
			  
			  FROM student INNER JOIN step_student USING (student_id)
			  WHERE result = "correct"
			  GROUP BY student_name
			  ```
		- *Результат:*
			- ```
			  +--------------+------------+-------+------+---------+
			  | student_name | Kоличество | Номер | Ранг | Рейтинг |
			  +--------------+------------+-------+------+---------+
			  | student_60   | 32         | 1     | 1    | 1       |
			  | student_15   | 30         | 2     | 2    | 2       |
			  | student_18   | 30         | 3     | 2    | 2       |
			  | student_27   | 30         | 4     | 2    | 2       |
			  | student_30   | 30         | 5     | 2    | 2       |
			  | student_31   | 30         | 6     | 2    | 2       |
			  | student_36   | 30         | 7     | 2    | 2       |
			  | student_39   | 30         | 8     | 2    | 2       |
			  | student_4    | 30         | 9     | 2    | 2       |
			  | student_43   | 30         | 10    | 2    | 2       |
			  | student_44   | 30         | 11    | 2    | 2       |
			  | student_46   | 30         | 12    | 2    | 2       |
			  | student_49   | 30         | 13    | 2    | 2       |
			  | student_51   | 30         | 14    | 2    | 2       |
			  | student_53   | 30         | 15    | 2    | 2       |
			  | student_59   | 29         | 16    | 16   | 3       |
			  | student_9    | 29         | 17    | 16   | 3       |
			  | student_23   | 28         | 18    | 18   | 4       |
			  | student_50   | 27         | 19    | 19   | 5       |
			                        ...
			  | student_5    | 9          | 61    | 60   | 15      |
			  | student_63   | 9          | 62    | 60   | 15      |
			  | student_29   | 8          | 63    | 63   | 16      |
			  | student_47   | 8          | 64    | 63   | 16      |
			  +--------------+------------+-------+------+---------+
			  Affected rows: 64
			  ```
		- С помощью функции **RANK()** и** DENSE_RANK()** все
		  студенты, имеющие 30  верно пройденных шагов, получили ранг 2 
		  и  рейтинг 2. Студентам с 29 балами присвоен ранг 16 и  рейтинг 3.
	- ### Пример 2
	  collapsed:: true
		- Для каждого студента указать, на сколько меньше он прошел шагов, чем идущий перед ним по рейтингу студент.
		- Запрос
			- ```SQL
			  SELECT student_name, count(DISTINCT step_id) AS Количество,
			  
			         LAG(count(DISTINCT step_id)) 
			         OVER (ORDER BY  count(DISTINCT step_id) DESC) - count(DISTINCT step_id) AS Разница
			  
			  FROM student INNER JOIN step_student USING (student_id)
			  WHERE result = "correct"
			  GROUP BY student_name
			  ```
		- *Результат:*
			- ```
			  +--------------+------------+---------+
			  | student_name | Количество | Разница |
			  +--------------+------------+---------+
			  | student_60   | 32         | None    |
			  | student_15   | 30         | 2       |
			  | student_18   | 30         | 0       |
			  | student_27   | 30         | 0       |
			  | student_30   | 30         | 0       |
			  | student_31   | 30         | 0       |
			  | student_36   | 30         | 0       |
			  
			  | student_63   | 9          | 0       |
			  | student_29   | 8          | 1       |
			  | student_47   | 8          | 0       |
			  +--------------+------------+---------+
			  Affected rows: 64
			  ```
		- Так как у первой записи нет предыдущей - значение разницы **NULL**. Заменим ее на 0 с помощью функции:
		- ```
		  IFNULL(выражение, результат)
		  ```
		- которая возвращает результат, если выражение равно **NULL**, и само выражение в противном случае.
		- Запрос
			- ```SQL
			  SELECT student_name, count(DISTINCT step_id) AS Количество,
			  
			         IFNULL(LAG(count(DISTINCT step_id)) 
			                OVER (ORDER BY  count(DISTINCT step_id) DESC) - count(DISTINCT step_id), 
			                0) AS Разница
			  
			  FROM student INNER JOIN step_student USING (student_id)
			  WHERE result = "correct"
			  GROUP BY student_name
			  ```
		- Результат
			- ```SQL
			  +--------------+------------+---------+
			  | student_name | Количество | Разница |
			  +--------------+------------+---------+
			  | student_60   | 32         | 0       |
			  | student_15   | 30         | 2       |
			  | student_18   | 30         | 0       |
			  | student_27   | 30         | 0       |
			  | student_30   | 30         | 0       |
			  | student_31   | 30         | 0       |
			  | student_36   | 30         | 0       |
			                ...
			  | student_63   | 9          | 0       |
			  | student_29   | 8          | 1       |
			  | student_47   | 8          | 0       |
			  +--------------+------------+---------+
			  Affected rows: 64
			  ```
		-
	- ### Задание
	  collapsed:: true
		- Для студента с именем** student_61** вывести все его попытки: название шага, результат и дату отправки попытки (**submission_time**).
		   Информацию отсортировать по дате отправки попытки и указать, сколько 
		  минут прошло между отправкой соседних попыток. Название шага ограничить 
		  20 символами и добавить "...". Столбцы назвать **Студент, Шаг, Результат, Дата_отправки, Разница**.
		- Запрос
			- ```SQL
			  SELECT student_name AS Студент, 
			         CONCAT(LEFT(step_name, 20), '...') AS Шаг, 
			         result AS Результат, 
			         FROM_UNIXTIME(submission_time) AS Дата_отправки,
			         SEC_TO_TIME(IFNULL(submission_time - LAG(submission_time) OVER (ORDER BY submission_time), 0)) AS Разница
			    FROM 
			         student
			         INNER JOIN step_student USING(student_id)
			         INNER JOIN step         USING(step_id)
			   WHERE student_name = "student_61"
			  
			  ```
		- Результат
			- ```
			  Query result:
			  +------------+-------------------------+-----------+---------------------+------------------+
			  | Студент    | Шаг                     | Результат | Дата_отправки       | Разница          |
			  +------------+-------------------------+-----------+---------------------+------------------+
			  | student_61 | Выборка всех данных ... | correct   | 2020-08-27 14:22:14 | 0:00:00          |
			  | student_61 | Выборка отдельных ст... | correct   | 2020-08-27 14:23:53 | 0:01:39          |
			  | student_61 | Выборка отдельных ст... | correct   | 2020-08-27 14:28:41 | 0:04:48          |
			  | student_61 | Выборка данных с соз... | wrong     | 2020-08-27 14:33:57 | 0:05:16          |
			  | student_61 | Выборка данных с соз... | wrong     | 2020-08-27 14:34:24 | 0:00:27          |
			  | student_61 | Выборка данных с соз... | correct   | 2020-08-27 14:34:50 | 0:00:26          |
			  | student_61 | Выборка данных, вычи... | correct   | 2020-08-27 14:42:44 | 0:07:54          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 14:54:06 | 0:11:22          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 14:55:04 | 0:00:58          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 14:58:23 | 0:03:19          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 14:58:56 | 0:00:33          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 14:59:09 | 0:00:13          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 14:59:49 | 0:00:40          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 15:01:00 | 0:01:11          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 15:05:20 | 0:04:20          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 15:06:19 | 0:00:59          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 15:06:58 | 0:00:39          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 15:08:40 | 0:01:42          |
			  | student_61 | Выборка данных, вычи... | wrong     | 2020-08-27 15:09:02 | 0:00:22          |
			  | student_61 | Выборка данных, вычи... | correct   | 2020-08-27 15:13:06 | 0:04:04          |
			  | student_61 | Выборка данных по ус... | wrong     | 2020-08-27 15:21:02 | 0:07:56          |
			  | student_61 | Выборка данных по ус... | correct   | 2020-08-27 15:21:18 | 0:00:16          |
			  | student_61 | Выборка данных, логи... | correct   | 2020-08-27 15:26:05 | 0:04:47          |
			  | student_61 | Выборка данных, опер... | correct   | 2020-08-27 15:31:31 | 0:05:26          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:42:30 | 0:10:59          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:43:35 | 0:01:05          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:48:09 | 0:04:34          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:49:47 | 0:01:38          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:52:13 | 0:02:26          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:57:41 | 0:05:28          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:57:53 | 0:00:12          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:58:28 | 0:00:35          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 15:59:58 | 0:01:30          |
			  | student_61 | Выборка данных, опер... | wrong     | 2020-08-27 16:00:22 | 0:00:24          |
			  | student_61 | Выборка данных, опер... | correct   | 2020-08-27 16:01:05 | 0:00:43          |
			  | student_61 | Выборка данных с сор... | wrong     | 2020-08-27 16:12:51 | 0:11:46          |
			  | student_61 | Выборка данных с сор... | correct   | 2020-08-27 16:14:15 | 0:01:24          |
			  | student_61 | Соединение INNER JOI... | correct   | 2020-09-01 07:25:39 | 4 days, 15:11:24 |
			  | student_61 | Внешнее соединение L... | wrong     | 2020-09-01 09:53:30 | 2:27:51          |
			  | student_61 | Внешнее соединение L... | correct   | 2020-09-01 09:53:50 | 0:00:20          |
			  | student_61 | Перекрестное соедине... | wrong     | 2020-09-01 10:45:30 | 0:51:40          |
			  | student_61 | Перекрестное соедине... | wrong     | 2020-09-01 10:46:21 | 0:00:51          |
			  | student_61 | Перекрестное соедине... | correct   | 2020-09-01 10:47:55 | 0:01:34          |
			  +------------+-------------------------+-----------+---------------------+------------------+
			  Affected rows: 43
			  ```
	- ### Задание
	  collapsed:: true
		- Посчитать среднее время, за которое пользователи проходят урок по следующему алгоритму:
			- для каждого пользователя вычислить время прохождения **шага**
			  как сумму времени, потраченного на каждую попытку (время попытки - это 
			  разница между временем отправки задания и временем начала попытки), при 
			  этом попытки, которые длились больше 4 часов не учитывать, так как 
			  пользователь мог просто оставить задание открытым в браузере, а 
			  вернуться к нему на следующий день;
			- для каждого студента посчитать общее время, которое он затратил на каждый **урок**;
			- вычислить среднее время выполнения урока в часах, результат округлить до 2-х знаков после запятой;
			- вывести информацию по возрастанию времени, пронумеровав строки, для каждого урока указать номер модуля и его позицию в нем.
			  
			  Столбцы результата назвать** Номер, Урок, Среднее_время**.
		- Запрос:
		  collapsed:: true
			- ```SQL
			  SELECT  row_number() over(order by Среднее_время) as Номер, Урок, Среднее_время
			    FROM (
			     SELECT
			          CONCAT(module_id, ".", lesson_position, " ", lesson_name) AS Урок, 
			          ROUND(AVG(ot.Общее_время/3600), 2) AS Среднее_время
			     FROM
			      (SELECT module_id, lesson_position, lesson_name, student_id, lesson_id, SUM(mc.Время) AS Общее_время    
			         FROM 
			         (
			           SELECT module_id, lesson_position, lesson_name, student_id, step_id, lesson_id, SUM(submission_time - attempt_time) AS Время   
			             FROM 
			                  module
			                  INNER JOIN lesson       USING(module_id)
			                  INNER JOIN step         USING(lesson_id)
			                  INNER JOIN step_student USING(step_id) 
			            WHERE submission_time - attempt_time < 4 * 3600
			            GROUP BY student_id, step_id
			         ) AS mc       
			     GROUP BY student_id, lesson_id) AS ot
			     
			   GROUP BY Урок
			   ORDER BY Среднее_время ASC) AS jj
			  ```
		- Результат
		  collapsed:: true
			- ```
			  Query result:
			  +-------+-------------------------------------------------------------+---------------+
			  | Номер | Урок                                                        | Среднее_время |
			  +-------+-------------------------------------------------------------+---------------+
			  | 1     | 2.2 Запросы на выборку, соединение таблиц                   | 2.37          |
			  | 2     | 1.2 Выборка данных                                          | 2.65          |
			  | 3     | 2.4 База данных "Интернет-магазин книг", запросы на выборку | 3.65          |
			  +-------+-------------------------------------------------------------+---------------+
			  Affected rows: 3
			  ```
- ### Оконные функции. Оператор OVER, PARTITION BY
  collapsed:: true
	- Рассмотрим оконную функцию, которая включает два раздела:
	- ```SQL
	  название_функции(выражение) 
	  OVER (
	        PARTITION BY ...
	        ORDER BY ... 
	  )
	  ```
	- Такое оконное выражение позволяет выполнять одинаковые действия
	  над всеми записями таблицы, ограниченными "окном". Столбцы, образующие 
	  окно записываются после  PARTITION BY. Окном считается совокупность 
	  записей, имеющих в столбцах, указанных после  PARTITION BY, одинаковые 
	  значения.
	- В качестве функций можно использовать те же функции, которые применялись в оконных функциях без указания окна:
	  **ROW_NUMBER() **- просто нумерация строк внутри окна;
	  **RANK() **- ранжирование строк внутри окна - при одинаковом значении строкам присваивается один номер, с пропуском номеров;
	  **DENSE_RANK()** - ранжирование строк внутри окна без пропуска номеров;
	  **LAG()** - выбирает строку внутри окна, предшествующую текущей, если таковой нет - выдается NULL;
	  **LEAD() **- выбирает строку внутри окна, следующую за текущей, если таковой нет - выдается NULL.
	- #### **Пример** 1
	  collapsed:: true
		- Вычислить, [сколько шагов прошел пользователь](https://stepik.org/lesson/404275/step/8?unit=393473) по каждому модулю. Ранжировать пользователей по убыванию результатов в каждом модуле.
		- Запрос:
		  collapsed:: true
			- ```SQL
			  WITH get_rate_lesson(mod_id, stud, rate) 
			  AS
			  (
			     SELECT module_id, student_name, count(DISTINCT step_id)
			     FROM student INNER JOIN step_student USING(student_id)
			                  INNER JOIN step USING (step_id)
			                  INNER JOIN lesson USING (lesson_id)
			     WHERE result = "correct"
			     GROUP BY module_id, student_name
			  )
			  SELECT mod_id AS Модуль, stud AS Студент, rate AS Рейтинг,
			      ROW_NUMBER() OVER (PARTITION BY mod_id ORDER BY  rate DESC) AS Номер,
			      RANK() OVER (PARTITION BY mod_id ORDER BY  rate DESC) AS Ранг,
			      DENSE_RANK() OVER (PARTITION BY mod_id ORDER BY  rate DESC) AS Рейтинг  
			  FROM get_rate_lesson
			  ```
		- Результат:
		  collapsed:: true
			- ```
			  +--------+------------+---------+-------+------+---------+
			  | Модуль | Студент    | Рейтинг | Номер | Ранг | Рейтинг |
			  +--------+------------+---------+-------+------+---------+
			  | 1      | student_1  | 11      | 1     | 1    | 1       |
			  | 1      | student_10 | 11      | 2     | 1    | 1       |
			  | 1      | student_11 | 11      | 3     | 1    | 1       |
			  | 1      | student_12 | 11      | 4     | 1    | 1       |
			  | 1      | student_13 | 11      | 5     | 1    | 1       |
			                          ...
			  | 1      | student_29 | 8       | 63    | 63   | 4       |
			  | 1      | student_47 | 8       | 64    | 63   | 4       |
			  | 2      | student_60 | 21      | 1     | 1    | 1       |
			  | 2      | student_15 | 19      | 2     | 2    | 2       |
			                          ...
			  | 2      | student_56 | 9       | 23    | 22   | 7       |
			  | 2      | student_34 | 8       | 24    | 24   | 8       |
			  | 2      | student_40 | 8       | 25    | 24   | 8       |
			  | 2      | student_11 | 5       | 26    | 26   | 9       |
			  | 2      | student_48 | 5       | 27    | 26   | 9       |
			  | 2      | student_42 | 4       | 28    | 28   | 10      |
			  | 2      | student_61 | 3       | 29    | 29   | 11      |
			  | 2      | student_13 | 2       | 30    | 30   | 12      |
			  | 2      | student_26 | 2       | 31    | 30   | 12      |
			  +--------+------------+---------+-------+------+---------+
			  Affected rows: 95
			  ```
		- Как видно из результирующей таблицы, и нумерация, и ранжирование, и рейтинг осуществляется сначала (с 1) для каждого модуля.
		  Другой тип функций - это функции, которые используются для вычислений со значениями столбцов, входящих в окно:
		- ```
		  SUM(), MAX(), MIN(), AVG(), COUNT()
		  ```
		- По записи они точно соответствуют групповым функциям, при этом 
		  вычисленное значение заносится в каждую запись окна. В то время как при 
		  использовании группировки возвращается одна запись для каждой группы.
		- Как правило, эти функции используются в следующем контексте:
		- ```SQL
		  название_функции(выражение) 
		  OVER (
		        PARTITION BY ...
		  )
		  ```
	- **Пример 2**
	  collapsed:: true
		- Посчитать, сколько шагов пройдено пользователями по каждому 
		  уроку. Вывести максимальное и минимальное значение пройденных шагов по 
		  каждому модулю.
		- *Запрос:*
			- ```SQL
			  WITH get_rate_lesson(mod_id, les, rate) 
			  AS
			  (
			     SELECT module_id,CONCAT(module_id,'.', lesson_position),count(DISTINCT step_id)
			     FROM step_student INNER JOIN step USING (step_id)
			                       INNER JOIN lesson USING (lesson_id)
			     WHERE result = "correct"
			     GROUP BY module_id, 2
			  )
			  SELECT mod_id AS Модуль, les AS Урок, rate AS Пройдено_шагов, 
			      MAX(rate) OVER (PARTITION BY mod_id) AS Максимум_по_модулю,
			      MIN(rate) OVER (PARTITION BY mod_id) AS Минимум_по_модулю
			  FROM get_rate_lesson
			  ```
		- *Результат:*
			- ```
			  +--------+------+----------------+--------------------+-------------------+
			  | Модуль | Урок | Пройдено_шагов | Максимум_по_модулю | Минимум_по_модулю |
			  +--------+------+----------------+--------------------+-------------------+
			  | 1      | 1.2  | 11             | 11                 | 11                |
			  | 2      | 2.2  | 8              | 13                 | 8                 |
			  | 2      | 2.4  | 13             | 13                 | 8                 |
			  +--------+------+----------------+--------------------+-------------------+
			  Affected rows: 3
			  ```
	- ## Задание 1
	  collapsed:: true
		- Вычислить рейтинг каждого студента относительно студента, 
		  прошедшего наибольшее количество шагов в модуле (вычисляется как 
		  отношение количества пройденных студентом шагов к максимальному 
		  количеству пройденных шагов, умноженное на 100). Вывести номер модуля, 
		  имя студента, количество пройденных им шагов и относительный рейтинг. 
		  Относительный рейтинг округлить до одного знака после запятой. Столбцы 
		  назвать **Модуль**, **Студент**, **Пройдено_шагов** и **Относительный_рейтинг** 
		   соответственно. Информацию отсортировать сначала по возрастанию номера 
		  модуля, потом по убыванию относительного рейтинга и, наконец, по имени 
		  студента в алфавитном порядке.
		- Запрос:
		  collapsed:: true
			- ```SQL
			  WITH get_rate_lesson(mod_id, stud, rate) 
			  AS
			  (
			     SELECT module_id, student_name, count(DISTINCT step_id)
			     FROM student INNER JOIN step_student USING(student_id)
			                  INNER JOIN step USING (step_id)
			                  INNER JOIN lesson USING (lesson_id)
			     WHERE result = "correct"
			     GROUP BY module_id, student_name
			  )
			  SELECT mod_id AS Модуль, stud AS Студент, rate  AS Пройдено_шагов, 
			         ROUND(rate/MAX(rate) OVER (PARTITION BY mod_id)*100,1) AS Относительный_рейтинг
			    FROM get_rate_lesson 
			   ORDER BY mod_id ASC, Относительный_рейтинг DESC, stud ASC
			  ```
		- Результат:
		  collapsed:: true
			- ```
			  +--------+------------+----------------+-----------------------+
			  | Модуль | Студент    | Пройдено_шагов | Относительный_рейтинг |
			  +--------+------------+----------------+-----------------------+
			  | 1      | student_1  | 11             | 100.0                 |
			  | 1      | student_10 | 11             | 100.0                 |
			  | 1      | student_11 | 11             | 100.0                 |
			                                ...
			  | 1      | student_47 | 8              | 72.7                  |
			  | 2      | student_60 | 21             | 100.0                 |
			  | 2      | student_15 | 19             | 90.5                  |
			  | 2      | student_18 | 19             | 90.5                  |
			  | 2      | student_27 | 19             | 90.5                  |
			  | 2      | student_30 | 19             | 90.5                  |
			  | 2      | student_31 | 19             | 90.5                  |
			  | 2      | student_36 | 19             | 90.5                  |
			  | 2      | student_39 | 19             | 90.5                  |
			  | 2      | student_4  | 19             | 90.5                  |
			  | 2      | student_43 | 19             | 90.5                  |
			  | 2      | student_44 | 19             | 90.5                  |
			  | 2      | student_46 | 19             | 90.5                  |
			  | 2      | student_49 | 19             | 90.5                  |
			                                 ...
			  | 2      | student_48 | 5              | 23.8                  |
			  | 2      | student_42 | 4              | 19.0                  |
			  | 2      | student_61 | 3              | 14.3                  |
			  | 2      | student_13 | 2              | 9.5                   |
			  | 2      | student_26 | 2              | 9.5                   |
			  +--------+------------+----------------+-----------------------+
			  Affected rows: 95
			  ```
	- ## Задание 2
	  collapsed:: true
		- Проанализировать, в каком порядке и с каким интервалом 
		  пользователь отправлял последнее верно выполненное задание каждого 
		  урока. В базе занесены попытки студентов  для трех уроков курса, поэтому
		   анализ проводить только для этих уроков.
		  
		  Для студентов прошедших как минимум по одному шагу в каждом уроке, 
		  найти последний пройденный шаг каждого урока - крайний шаг, и указать:
			- имя студента;
			- номер урока, состоящий из номера модуля и через точку позиции каждого урока в модуле;
			- время отправки  - время подачи решения на проверку;
			- разницу во времени отправки между текущим и предыдущим крайним 
			  шагом в днях, при этом для первого шага поставить прочерк ("-"), а 
			  количество дней округлить до целого в большую сторону.
			  
			  Столбцы назвать  **Студент**, **Урок**,  **Макс_время_отправки** и **Интервал ** соответственно. Отсортировать результаты по имени студента в алфавитном порядке, а потом по возрастанию времени отправки.
		- Запрос
		  collapsed:: true
			- ```SQL
			  WITH max_time AS (
			      SELECT student_name, CONCAT(module_id, '.', lesson_position) AS Урок, MAX(submission_time) AS mt
			        FROM step_student JOIN step USING(step_id) JOIN lesson USING(lesson_id) JOIN student USING(student_id)
			       WHERE result = 'correct'
			       GROUP BY student_name, lesson_id),
			       requirements AS (
			      SELECT student_name
			        FROM max_time
			       GROUP BY student_name
			      HAVING COUNT(*) >= 3 )
			    
			  SELECT student_name AS Студент, Урок, FROM_UNIXTIME(mt) AS Макс_время_отправки, 
			         IFNULL(CEIL((mt - LAG(mt) OVER(PARTITION BY student_name ORDER BY mt)) / 86400), '-') AS Интервал
			    FROM max_time JOIN requirements USING(student_name)
			   ORDER BY 1, 3
			  
			  ```
		- **Результат**
		  collapsed:: true
			- ```
			  
			  Query result:
			  +------------+--------+---------------+-----------+---------------+---------------------+
			  | Студент    | Шаг    | Номер_попытки | Результат | Время_попытки | Относительное_время |
			  +------------+--------+---------------+-----------+---------------+---------------------+
			  | student_59 | 1.2.2  | 1             | correct   | 0:00:28       | 100.00              |
			  | student_59 | 1.2.3  | 1             | correct   | 0:01:11       | 100.00              |
			  | student_59 | 1.2.4  | 1             | correct   | 0:06:09       | 100.00              |
			  | student_59 | 1.2.5  | 1             | correct   | 0:02:24       | 100.00              |
			  | student_59 | 1.2.6  | 1             | wrong     | 0:09:42       | 90.37               |
			  | student_59 | 1.2.6  | 2             | wrong     | 0:00:05       | 0.78                |
			  | student_59 | 1.2.6  | 3             | wrong     | 0:00:23       | 3.57                |
			  | student_59 | 1.2.6  | 4             | wrong     | 0:00:10       | 1.55                |
			  | student_59 | 1.2.6  | 5             | correct   | 0:00:20       | 3.11                |
			  | student_59 | 1.2.6  | 6             | correct   | 0:00:04       | 0.62                |
			  | student_59 | 1.2.7  | 1             | wrong     | 0:11:44       | 98.88               |
			  | student_59 | 1.2.7  | 2             | correct   | 0:00:08       | 1.12                |
			  | student_59 | 1.2.8  | 1             | correct   | 0:02:23       | 100.00              |
			  | student_59 | 1.2.9  | 1             | wrong     | 0:04:53       | 92.72               |
			  | student_59 | 1.2.9  | 2             | correct   | 0:00:23       | 7.28                |
			  | student_59 | 1.2.10 | 1             | wrong     | 0:03:19       | 76.83               |
			  | student_59 | 1.2.10 | 2             | wrong     | 0:00:07       | 2.70                |
			  | student_59 | 1.2.10 | 3             | correct   | 0:00:53       | 20.46               |
			  | student_59 | 1.2.11 | 1             | wrong     | 0:15:50       | 79.56               |
			  | student_59 | 1.2.11 | 2             | wrong     | 0:00:06       | 0.50                |
			  | student_59 | 1.2.11 | 3             | wrong     | 0:00:10       | 0.84                |
			  | student_59 | 1.2.11 | 4             | wrong     | 0:00:29       | 2.43                |
			  | student_59 | 1.2.11 | 5             | wrong     | 0:00:07       | 0.59                |
			  | student_59 | 1.2.11 | 6             | wrong     | 0:00:08       | 0.67                |
			  | student_59 | 1.2.11 | 7             | wrong     | 0:00:04       | 0.34                |
			  | student_59 | 1.2.11 | 8             | wrong     | 0:00:24       | 2.01                |
			  | student_59 | 1.2.11 | 9             | wrong     | 0:00:07       | 0.59                |
			  | student_59 | 1.2.11 | 10            | wrong     | 0:00:10       | 0.84                |
			  | student_59 | 1.2.11 | 11            | wrong     | 0:02:11       | 10.97               |
			  | student_59 | 1.2.11 | 12            | correct   | 0:00:08       | 0.67                |
			  | student_59 | 1.2.12 | 1             | correct   | 0:07:10       | 100.00              |
			  | student_59 | 2.2.2  | 1             | correct   | 0:08:52       | 100.00              |
			  | student_59 | 2.2.3  | 1             | wrong     | 0:11:31       | 98.86               |
			  | student_59 | 2.2.3  | 2             | correct   | 0:00:08       | 1.14                |
			  | student_59 | 2.2.4  | 1             | wrong     | 0:17:46       | 93.18               |
			  | student_59 | 2.2.4  | 2             | wrong     | 0:00:51       | 4.46                |
			  | student_59 | 2.2.4  | 3             | wrong     | 0:00:15       | 1.31                |
			  | student_59 | 2.2.4  | 4             | wrong     | 0:00:08       | 0.70                |
			  | student_59 | 2.2.4  | 5             | wrong     | 0:00:04       | 0.35                |
			  | student_59 | 2.2.5  | 1             | correct   | 0:07:10       | 100.00              |
			  | student_59 | 2.2.6  | 1             | correct   | 0:24:35       | 100.00              |
			  | student_59 | 2.2.7  | 1             | wrong     | 0:53:14       | 99.29               |
			  | student_59 | 2.2.7  | 2             | correct   | 0:00:23       | 0.71                |
			  | student_59 | 2.2.8  | 1             | wrong     | 0:07:10       | 48.31               |
			  | student_59 | 2.2.8  | 2             | correct   | 0:07:40       | 51.69               |
			  | student_59 | 2.2.9  | 1             | correct   | 0:31:13       | 100.00              |
			  | student_59 | 2.4.2  | 1             | correct   | 0:03:31       | 100.00              |
			  | student_59 | 2.4.3  | 1             | correct   | 0:08:21       | 100.00              |
			  | student_59 | 2.4.5  | 1             | correct   | 0:07:10       | 100.00              |
			  | student_59 | 2.4.6  | 1             | correct   | 0:13:38       | 100.00              |
			  | student_59 | 2.4.7  | 1             | correct   | 0:21:18       | 100.00              |
			  | student_59 | 2.4.8  | 1             | correct   | 0:33:02       | 100.00              |
			  | student_59 | 2.4.9  | 1             | wrong     | 0:18:12       | 71.75               |
			  | student_59 | 2.4.9  | 2             | correct   | 0:07:10       | 28.25               |
			  | student_59 | 2.4.10 | 1             | correct   | 0:05:32       | 100.00              |
			  | student_59 | 2.4.11 | 1             | correct   | 0:40:27       | 100.00              |
			  | student_59 | 2.4.12 | 1             | correct   | 0:07:10       | 100.00              |
			  | student_59 | 2.4.13 | 1             | correct   | 0:07:15       | 100.00              |
			  +------------+--------+---------------+-----------+---------------+---------------------+
			  Affected rows: 58
			  ```
-